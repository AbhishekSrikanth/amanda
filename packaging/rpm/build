#!/bin/bash

DEFINES=
[[ "$*" == *release* ]] && DEFINES=(--define 'bundle release' --define 'bitrock_build 1')
ODEFINES="${DEFINES[@]}"

buildtype=${1:-both}
shift

# must set before including build-functions.sh
[ $buildtype = platform ] && pkg_name=zmanda-platforms

BUILDVER="4.0"
git --git-dir=.git/modules/tools-archives \
   ls-files stack-output/php | grep -q . &&
   unset BUILDVER

# set the var buildpkg_dir as well
. ./packaging/common/build_functions.sh
. ./packaging/common/set_zmanda_version

export PKG_DIR=$(realpath .)
mach=`uname -m`

do_rpm_package() {
    gen_pkg_build_config $buildpkg_dir
    # take the spec/spec.src files and make a tarfile
    gen_top_environ
    touch rpmbuild/SOURCES/${PKG_NAME_VER}.tar.gz 
    #
    #
    #
    do_top_package "$@"
}

set -e

case "$buildtype,$mach,$BUILDVER" in
   both,x86_64,*)
#        do_rpm_package "amanda_enterprise${BUILDVER}.spec" \
#              "${DEFINES[@]}" \
#              --define "subpkg server"
        #
#        STACK_BRANCH=none do_rpm_package "amanda_enterprise_client${BUILDVER}.spec" \
#              --define "subpkg client"
        #
        exit 100
        ;;

   server,x86_64,*)
        do_rpm_package "amanda_enterprise${BUILDVER}.spec" \
              "${DEFINES[@]}" \
              --define "subpkg server"


        ;;

   client,*,*) ;&  both,*,*)
	STACK_BRANCH=none do_rpm_package "amanda_enterprise_client${BUILDVER}.spec" \
              --define "subpkg client"

      ;;

   platform,x86_64,*)
	do_rpm_package "zmanda-platform${BUILDVER}.spec" \
              "${DEFINES[@]}"
      ;;

   *) echo "ERROR: cannot build combination of $buildtype-$mach-${BUILDVER:-3.6}" >&2; exit -1 ;;
esac

true
